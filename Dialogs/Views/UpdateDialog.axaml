<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:ProxyChecker.Dialogs.ViewModels"
             xmlns:models="clr-namespace:ProxyChecker.Dialogs.Models"
             xmlns:converters="clr-namespace:ProxyChecker.Converters"
             xmlns:u="https://irihi.tech/ursa"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="ProxyChecker.Dialogs.Views.UpdateDialog"
             x:DataType="vm:UpdateViewModel">

    <UserControl.Resources>
        <converters:EnumToBoolConverter x:Key="EnumToBooleanConverter" />
    </UserControl.Resources>

    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="20" MinWidth="500">
        <!-- Progress Circle and Avatar -->
        <Panel>
            <ProgressBar
                Name="Bar"
                Theme="{DynamicResource ProgressRing}"
                Width="180"
                Height="180"
                Classes.Success="{Binding Status,
                                  Converter={StaticResource EnumToBooleanConverter},
                                  ConverterParameter={x:Static models:DownloadStatus.Completed},
                                  Mode=OneWay}"
                Value="{Binding Statistics.ProgressPercentage}">
                <ProgressBar.Styles>
                    <Style Selector="ProgressBar">
                        <Setter Property="Transitions">
                            <Transitions>
                                <DoubleTransition Easing="CubicEaseInOut" Property="Value" Duration="0:0:0.3" />
                                <BrushTransition Property="Foreground" Duration="0:0:0.3" />
                            </Transitions>
                        </Setter>
                    </Style>
                </ProgressBar.Styles>
            </ProgressBar>

            <u:Avatar
                Width="130"
                Height="130"
                Opacity="{Binding Statistics.ProgressPercentage,
                          Converter={x:Static converters:ProgressConverter.ProgressToOpacityConverter}}"
                Classes="Circle"
                Source="avares://ProxyChecker/Assets/Logo.png">
                 <u:Avatar.Styles>
                    <Style Selector="Image">
                        <Setter Property="Transitions">
                            <Transitions>
                                <DoubleTransition Easing="CubicEaseInOut" Property="Opacity" Duration="0:0:0.3" />
                            </Transitions>
                        </Setter>
                    </Style>
                </u:Avatar.Styles>
            </u:Avatar>
        </Panel>

        <!-- Title -->
        <SelectableTextBlock
            HorizontalAlignment="Center"
            FontSize="20"
            FontWeight="Bold">
            <Run Text="ProxyChecker" />
            <Run Text="{Binding Statistics.Version}" />
            <Run Text="版本更新" />
        </SelectableTextBlock>

        <!-- Release Notes -->
        <Border Height="150"
                Width="400"
                Background="{DynamicResource SemiColorFill0}"
                CornerRadius="6"
                Padding="10"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.NotStarted},
                            Mode=OneWay}">
            <ScrollViewer>
                <SelectableTextBlock Text="{Binding ReleaseNotes}" TextWrapping="Wrap" />
            </ScrollViewer>
        </Border>

        <!-- Status Text -->
        <Panel>
            <SelectableTextBlock
                HorizontalAlignment="Center"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.NotStarted},
                            Mode=OneWay}"
                Text="发现新版本，是否立即更新？" />

            <SelectableTextBlock
                HorizontalAlignment="Center"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Downloading},
                            Mode=OneWay}"
                Text="{Binding Statistics.ProgressPercentage, StringFormat='正在下载... {0:F0}%'}" />

            <SelectableTextBlock
                HorizontalAlignment="Center"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Completed},
                            Mode=OneWay}"
                Text="下载完成" />

             <SelectableTextBlock
                HorizontalAlignment="Center"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Failed},
                            Mode=OneWay}"
                Text="下载失败" Foreground="{DynamicResource SemiBrushDanger}" />
        </Panel>

        <!-- Controls -->
        <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">

            <!-- Start Update -->
            <Button
                Content="立即更新"
                Classes="Primary"
                Command="{Binding StartCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.NotStarted},
                            Mode=OneWay}" />

            <!-- Cancel Update -->
            <Button
                Content="暂不更新"
                Classes="Secondary"
                Command="{Binding CloseCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.NotStarted},
                            Mode=OneWay}" />

            <!-- Stop / Cancel -->
            <u:IconButton
                Name="StopButton"
                Theme="{StaticResource BorderlessIconButton}"
                Classes="Danger"
                ToolTip.Tip="取消"
                Icon="{StaticResource SemiIconStop}"
                Command="{Binding StopCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Downloading},
                            Mode=OneWay}" />

            <!-- Restart / Retry -->
            <u:IconButton
                Name="RestartButton"
                Theme="{StaticResource BorderlessIconButton}"
                Classes="Tertiary"
                ToolTip.Tip="重试"
                Icon="{StaticResource SemiIconRefresh}"
                Command="{Binding RestartCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Failed},
                            Mode=OneWay}"/>

            <!-- Apply and Restart App -->
            <Button
                Content="立即重启"
                Classes="Primary"
                Command="{Binding ApplyAndRestartCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Completed},
                            Mode=OneWay}" />

            <!-- Close (if failed or not started) -->
            <Button
                Content="关闭"
                Classes="Secondary"
                Command="{Binding CloseCommand}"
                IsVisible="{Binding Status,
                            Converter={StaticResource EnumToBooleanConverter},
                            ConverterParameter={x:Static models:DownloadStatus.Failed},
                            Mode=OneWay}" />
        </StackPanel>
    </StackPanel>
</UserControl>
