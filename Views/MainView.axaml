<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ProxyChecker.ViewModels"
             xmlns:u="https://irihi.tech/ursa"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="ProxyChecker.Views.MainView"
             x:DataType="vm:MainViewModel"
             DragDrop.AllowDrop="True">

    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>

    <u:LoadingContainer
        IsLoading="{Binding IsLoading}"
        LoadingMessage="{Binding LoadingMessage}"
        HorizontalContentAlignment="Stretch"
        VerticalContentAlignment="Stretch">

        <Grid RowDefinitions="Auto,Auto,*"
              Margin="{OnPlatform macOS='5,20,5,5', Windows='5,30,5,5'}">

            <!-- 1. 顶部控制台 -->
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Spacing="20"
                        Margin="0,0,0,10">
                <StackPanel.Styles>
                    <Style Selector="Button">
                        <Setter Property="Width" Value="100"/>
                        <Setter Property="Height" Value="35"/>
                    </Style>
                </StackPanel.Styles>

                <Button Content="开始"
                        Classes="Success"
                        Command="{Binding StartCommand}"
                        IsEnabled="{Binding CanStart}"/>

                <Button Content="{Binding PauseButtonText}"
                        Command="{Binding PauseCommand}"
                        IsEnabled="{Binding CanPause}"/>

                <Button Content="停止"
                        Classes="Danger"
                        Command="{Binding StopCommand}"
                        IsEnabled="{Binding CanStop}"/>
            </StackPanel>

            <!-- 2. 设置区域 (Expander) -->
            <Expander Grid.Row="1" Margin="0,0,0,5" IsExpanded="False">
                <Grid ColumnDefinitions="Auto,*" Margin="10,8">
                    <!-- 左侧: 线程数 -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="线程数" VerticalAlignment="Center"/>
                        <u:NumericIntUpDown Width="80"
                                          Maximum="200"
                                          Minimum="1"
                                          HorizontalContentAlignment="Center"
                                          Value="{Binding Concurrency}"/>
                    </StackPanel>

                    <!-- 右侧: 搜索 + 过滤 -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right">
                        <TextBox Text="{Binding SearchText}"
                                 Watermark="搜索 IP / 端口 / 用户名..."
                                 Width="200"
                                 Classes="ClearButton"/>

                        <ComboBox Width="100"
                                  SelectedItem="{Binding FilterIsp}">
                             <sys:String>全部</sys:String>
                             <sys:String>移动</sys:String>
                             <sys:String>电信</sys:String>
                             <sys:String>联通</sys:String>
                             <sys:String>其他</sys:String>
                             <sys:String>失败</sys:String>
                        </ComboBox>
                    </StackPanel>
                </Grid>
            </Expander>

            <!-- 3. 数据列表区 / 空状态区 (共用 Grid.Row="2") -->
            <Grid Grid.Row="2">
                <!-- 数据列表 (有数据时显示) -->
                <Border IsVisible="{Binding HasData}"
                        Background="{DynamicResource SemiColorBackground1}"
                        BorderBrush="{DynamicResource SemiColorBorder}"
                        BorderThickness="1"
                        CornerRadius="12">
                    <Grid RowDefinitions="*,Auto">
                        <!-- 内容区：数据网格 -->
                        <TreeDataGrid Grid.Row="0"
                                      x:Name="ResultsGrid"
                                      Margin="8,8,8,8"
                                      Source="{Binding ResultsSource}"
                                      CanUserResizeColumns="True"
                                      CanUserSortColumns="True"
                                      Background="Transparent">
                            <TreeDataGrid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="复制"
                                              Command="{Binding CopyCommand}">
                                        <MenuItem.Icon>
                                            <PathIcon Data="M19 21H8V7h11v14zM8 5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8zm-3 0V3h11v2h-9a2 2 0 0 0-2 2v12H5V5z"
                                                      Width="14" Height="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="-" />
                                    <MenuItem Header="导出结果"
                                              Command="{Binding ExportAllCommand}">
                                        <MenuItem.Icon>
                                            <PathIcon Data="M5 20h14v-2H5v2zm0-10h4v6h6v-6h4l-7-7-7 7z"
                                                      Width="14" Height="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="清空结果"
                                              Command="{Binding ClearResultsCommand}">
                                        <MenuItem.Icon>
                                            <PathIcon Data="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12Z"
                                                      Width="14" Height="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="清空全部数据"
                                              Command="{Binding ClearAllCommand}">
                                        <MenuItem.Icon>
                                            <PathIcon Data="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12Z"
                                                      Width="14" Height="14"
                                                      Foreground="Red"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </TreeDataGrid.ContextMenu>
                        </TreeDataGrid>

                        <!-- 底部状态条 -->
                        <Border Grid.Row="1"
                                Background="{DynamicResource SemiColorBackground2}"
                                BorderBrush="{DynamicResource SemiColorBorder}"
                                BorderThickness="0,1,0,0"
                                CornerRadius="0,0,12,12"
                                ClipToBounds="True">
                            <Grid>
                                <!-- 进度条 -->
                                <ProgressBar VerticalAlignment="Top"
                                             Height="2"
                                             Foreground="{DynamicResource SemiColorPrimary}"
                                             Background="Transparent"
                                             Value="{Binding ProgressPercent}"
                                             Minimum="0"
                                             Maximum="100"
                                             IsIndeterminate="False"/>

                                <!-- 内容区域 -->
                                <Grid ColumnDefinitions="Auto,*,Auto" Margin="12,8">
                                    <Grid.Styles>
                                        <Style Selector="TextBlock">
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                            <Setter Property="FontSize" Value="13"/>
                                        </Style>
                                    </Grid.Styles>

                                    <!-- 左侧: 文件名 + 进度 -->
                                    <StackPanel Orientation="Horizontal" Spacing="15">
                                        <TextBlock Text="{Binding LoadedFileName}" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding ProgressText}" Foreground="{DynamicResource SemiColorText2}"/>
                                    </StackPanel>

                                    <!-- 中间: 统计 + ISP 分布 -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding SuccessCount, StringFormat='成功:{0}'}" Foreground="#10B981"/>
                                        <TextBlock Text="{Binding FailedCount, StringFormat='失败:{0}'}" Foreground="#EF4444"/>
                                        <TextBlock Text="{Binding UniqueIpCount, StringFormat='独立IP:{0}'}" Foreground="#3B82F6"/>
                                        <TextBlock Text="|" Foreground="{DynamicResource SemiColorBorder}"/>
                                        <TextBlock Text="{Binding IspDistribution}" Foreground="{DynamicResource SemiColorText2}"/>
                                    </StackPanel>

                                    <!-- 右侧: 耗时 + 速度 -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="12">
                                        <TextBlock Text="{Binding ElapsedTime}"/>
                                        <TextBlock Text="{Binding Speed}"/>
                                    </StackPanel>
                                </Grid>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>

                <!-- Empty State (覆盖在数据区，当无数据时显示) -->
                <Border IsVisible="{Binding HasNoData}"
                        Padding="0"
                        CornerRadius="12"
                        Background="{DynamicResource SemiColorBackground1}"
                        DragDrop.AllowDrop="True">
                    <Grid>
                        <!-- 底层渐变块 -->
                        <Border CornerRadius="12"
                                Margin="40"
                                Background="{DynamicResource SemiColorBackground2}"/>

                        <!-- 左上角装饰块 -->
                        <Border Width="120" Height="80"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Top"
                                Margin="60,40,0,0"
                                CornerRadius="16"
                                Background="{DynamicResource SemiColorPrimary}"
                                Opacity="0.06"/>

                        <!-- 右下角装饰块 -->
                        <Border Width="160" Height="100"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Bottom"
                                Margin="0,0,60,60"
                                CornerRadius="20"
                                Background="{DynamicResource SemiColorBackground3}"
                                Opacity="0.35"/>

                        <!-- 中心内容 -->
                        <StackPanel VerticalAlignment="Center"
                                    HorizontalAlignment="Center"
                                    Spacing="16">
                            <Border Width="96" Height="96"
                                    CornerRadius="24"
                                    Background="{DynamicResource SemiColorBackground1}"
                                    BorderBrush="{DynamicResource SemiColorBorder}"
                                    BorderThickness="1">
                                <PathIcon Data="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z M4 4h16v16H4V4zm2 2v12h12V6H6z"
                                          Width="56" Height="56"
                                          VerticalAlignment="Center"
                                          HorizontalAlignment="Center"
                                          Foreground="{DynamicResource SemiColorPrimary}"/>
                            </Border>

                            <TextBlock Text="拖放文件到此处开始检测"
                                       FontSize="22"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource SemiColorText0}"
                                       HorizontalAlignment="Center"/>

                            <TextBlock Text="支持 TXT 代理列表，拖入后自动解析并准备检测"
                                       FontSize="13"
                                       Foreground="{DynamicResource SemiColorText2}"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

        </Grid>
    </u:LoadingContainer>
</UserControl>
